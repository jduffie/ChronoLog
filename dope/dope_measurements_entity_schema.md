# dope_measurements Entity Schema

## Entity Description

The `DopeMeasurementModel` entity represents individual shot measurements within a DOPE (Data On Previous Engagement) session. This entity follows the project's metric-only internal processing requirements, with unit conversions handled only at data import/export boundaries and user interface display.

## Entity Fields

| **Field Name**          | **Data Type**      | **Nullable** | **Default**       | **Data Source**              | **Description**                                                    |
|-------------------------|--------------------|--------------|--------------------|------------------------------|--------------------------------------------------------------------|
| **id**                  | str                | NO           | gen_random_uuid()  | Database auto-generated      | UUID primary key, auto-generated by database                       |
| **dope_session_id**     | str                | NO           | -                  | Parent DOPE session          | Foreign key to dope_sessions table                                 |
| **user_id**             | str                | NO           | -                  | Auth0 authentication system  | User identifier for data isolation and security                    |
| **shot_number**         | int                | NO           | -                  | Chronograph measurement      | Sequential shot number within the session                          |
| **datetime_shot**       | datetime           | NO           | -                  | Chronograph measurement      | Timestamp when the shot was fired (with timezone support)          |
| **speed_mps**           | float              | NO           | -                  | Chronograph measurement      | Projectile velocity in meters per second (metric primary)          |
| **ke_j**                | Optional[float]    | YES          | None               | Chronograph measurement      | Kinetic energy in Joules (metric primary)                          |
| **power_factor_kgms**   | Optional[float]    | YES          | None               | Chronograph measurement      | Power factor in kg⋅m/s (metric primary)                            |
| **temperature_c**       | Optional[float]    | YES          | None               | Weather source               | Air temperature in Celsius (metric primary)                        |
| **pressure_hpa**        | Optional[float]    | YES          | None               | Weather source               | Barometric pressure in hectopascals (metric primary)               |
| **humidity_pct**        | Optional[float]    | YES          | None               | Weather source               | Relative humidity as percentage (0-100)                            |
| **distance_m**          | Optional[float]    | YES          | None               | User input via UI            | Target distance in meters (metric primary)                         |
| **elevation_adjustment**| Optional[float]    | YES          | None               | User input via UI            | Elevation scope adjustment                                         |
| **windage_adjustment**  | Optional[float]    | YES          | None               | User input via UI            | Windage scope adjustment                                           |
| **clean_bore**          | Optional[str]      | YES          | None               | User input via UI            | Bore cleanliness indicator (yes/no/fouled)                         |
| **cold_bore**           | Optional[str]      | YES          | None               | User input via UI            | Cold bore indicator (yes/no)                                       |
| **shot_notes**          | Optional[str]      | YES          | None               | User input via UI            | Free-form notes about the specific shot                            |
| **created_at**          | Optional[datetime] | YES          | now()              | Database auto-generated      | Record creation timestamp (auto-managed by database)               |
| **updated_at**          | Optional[datetime] | YES          | now()              | Database auto-generated      | Record last update timestamp (auto-managed by database)            |

## Key Relationships

- **dope_sessions**: Many-to-one relationship through `dope_session_id` foreign key
- **User Isolation**: All queries must include `.eq("user_id", user_id)` filter for security

## Metric-Only Design Principles

### 1. Internal Processing
All ballistic calculations, data storage, and business logic operations use metric units exclusively:
- Velocities in m/s (meters per second)
- Energies in J (Joules)
- Distances in m (meters)
- Temperatures in °C (Celsius)
- Pressures in hPa (hectopascals)
- Power factor in kg⋅m/s

### 2. Edge Conversion Only
Unit conversions occur only at system boundaries:
- **Data Import**: Convert imperial measurements from chronograph files to metric for storage
- **User Interface**: Display values in user's preferred units (metric or imperial)
- **Data Export**: Convert to target format's required units

### 3. Precision and Accuracy
Metric units provide better precision for ballistic calculations:
- Avoid compound rounding errors from multiple conversions
- Maintain scientific accuracy in ballistic computations
- Support international standards for precision shooting

## Required Fields (NOT NULL)

The following fields are required and cannot be null:

1. **id** - Primary key
2. **dope_session_id** - Must link to valid DOPE session
3. **user_id** - Required for data isolation
4. **shot_number** - Sequential identifier within session
5. **datetime_shot** - Timestamp of the shot
6. **speed_mps** - Core ballistic measurement (velocity)

These fields come from chronograph measurements and are essential for valid shot data.

## Entity Methods

### Core Methods
- `from_supabase_record(record: dict)` - Create entity from database record
- `from_supabase_records(records: List[dict])` - Batch creation from multiple records
- `to_dict()` - Convert entity to dictionary for database operations

### Display Methods (Handle Unit Conversion at UI Boundary)
- `get_speed_display(use_metric: bool = True)` - Format velocity for display
- `get_energy_display(use_metric: bool = True)` - Format kinetic energy for display
- `get_power_factor_display(use_metric: bool = True)` - Format power factor for display
- `environmental_display` - Format environmental conditions
- `adjustments_display` - Format scope adjustments
- `bore_conditions_display` - Format bore condition indicators

### Validation Methods
- `has_ballistic_data()` - Check if measurement contains velocity/energy data
- `has_environmental_data()` - Check if measurement contains environmental conditions
- `has_targeting_data()` - Check if measurement contains targeting geometry

## Business Logic Requirements

### Data Validation
1. **User Isolation**: All database operations must filter by user_id
2. **Session Linkage**: dope_session_id must reference valid, user-owned DOPE session
3. **Shot Sequencing**: shot_number must be unique within session
4. **Environmental Ranges**: Validate realistic ranges for temperature, pressure, humidity
5. **Ballistic Ranges**: Validate realistic ranges for velocities and energies

### Calculation Dependencies
1. **Kinetic Energy**: Requires both velocity (speed_mps) and bullet mass from parent session
2. **Power Factor**: Calculated from velocity and bullet mass
3. **Ballistic Coefficients**: Used with velocity for trajectory calculations (from bullet data in parent session)
4. **Environmental Corrections**: Temperature, pressure, humidity affect ballistic performance

### Data Integrity
1. **Orphan Prevention**: Foreign key constraint ensures valid dope_session_id
2. **Timestamp Consistency**: datetime_shot should fall within parent session time window
3. **Unit Consistency**: All metric fields must use consistent unit systems
4. **Precision Maintenance**: Avoid precision loss from unnecessary unit conversions

## Data Lineage

### Chronograph Measurements (Required)
These fields come directly from chronograph hardware and are required:
- `shot_number` - Sequential shot identifier
- `datetime_shot` - Timestamp of shot
- `speed_mps` - Projectile velocity
- `ke_j` - Kinetic energy (optional, can be calculated)
- `power_factor_kgms` - Power factor (optional, can be calculated)

### Weather Source (Optional)
Environmental conditions from linked weather measurement devices:
- `temperature_c` - Air temperature
- `pressure_hpa` - Barometric pressure
- `humidity_pct` - Relative humidity

### User Input via UI (Optional)
Targeting and adjustment data entered by user:
- `distance_m` - Target distance
- `elevation_adjustment` - Scope elevation adjustment
- `windage_adjustment` - Scope windage adjustment
- `clean_bore` - Bore cleanliness indicator
- `cold_bore` - Cold bore indicator
- `shot_notes` - Free-form notes

## Usage Patterns

### Creating New Measurements
```python
measurement = DopeMeasurementModel(
    id=None,  # Will be auto-generated
    dope_session_id=session_id,
    user_id=user_id,
    shot_number=1,  # Required
    datetime_shot=datetime.now(timezone.utc),  # Required
    speed_mps=850.5,  # Required - metric primary
    temperature_c=21.0,  # Optional - metric primary
    pressure_hpa=1013.25  # Optional - metric primary
)
```

### Importing from Imperial Sources
```python
# Convert at import boundary
speed_mps = speed_fps * 0.3048  # Convert fps to m/s
temp_c = (temp_f - 32) * 5/9    # Convert F to C
pressure_hpa = pressure_inhg * 33.8639  # Convert inHg to hPa

measurement = DopeMeasurementModel(
    dope_session_id=session_id,
    user_id=user_id,
    shot_number=shot_num,
    datetime_shot=shot_time,
    speed_mps=speed_mps,  # Required
    temperature_c=temp_c,
    pressure_hpa=pressure_hpa
)
```

### Display with User Preferences
```python
# UI layer handles unit preference
speed_display = measurement.get_speed_display(use_metric=user_prefers_metric)
energy_display = measurement.get_energy_display(use_metric=user_prefers_metric)
```

## Key Features

1. **User Isolation**: The `user_id` field ensures data is properly isolated per user
2. **Metric-Only Storage**: All measurements are stored in metric units internally
3. **Required Core Data**: Shot number, timestamp, and velocity are mandatory from chronograph
4. **Flexible Environmental Data**: Weather conditions are optional (may not be available)
5. **Shot Tracking**: Sequential shot numbering and timestamps for temporal analysis
6. **Environmental Context**: Captures conditions at the time of each shot for correlation analysis
7. **Parent Session Link**: All measurements are tied to a DOPE session for complete context

This entity design ensures that all internal processing maintains metric consistency while providing flexibility for user interface preferences and data import/export requirements.