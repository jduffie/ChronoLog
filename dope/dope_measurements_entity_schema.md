# dope_measurements Entity Schema

## Entity Description

The `DopeMeasurementModel` entity represents individual shot measurements within a DOPE (Data On Previous Engagement) session. This entity follows the project's metric-only internal processing requirements, with unit conversions handled only at data import/export boundaries and user interface display.

## Entity Fields (Metric-Only Design)

| **Field Name**               | **Data Type**            | **Nullable** | **Default** | **Description**                                                                                                                                                                               |
|------------------------------|--------------------------|--------------|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id                           | Optional[str]            | YES          | None        | UUID primary key, auto-generated by database                                                                                                                                                 |
| dope_session_id              | str                      | NO           | ""          | Foreign key to dope_sessions table - links measurement to its parent session                                                                                                                 |
| user_id                      | str                      | NO           | ""          | User identifier for data isolation and security                                                                                                                                               |
| shot_number                  | Optional[int]            | YES          | None        | Sequential shot number within the session (1, 2, 3, etc.)                                                                                                                                    |
| datetime_shot                | Optional[datetime]       | YES          | None        | Timestamp when the shot was fired (with timezone support)                                                                                                                                     |
| speed_mps                    | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Projectile velocity in meters per second - core ballistic measurement                                                                                                    |
| ke_j                         | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Kinetic energy in Joules - calculated from velocity and bullet mass                                                                                                      |
| power_factor_kgms            | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Power factor in kg⋅m/s - momentum measurement for competitive shooting                                                                                                   |
| azimuth_deg                  | Optional[float]          | YES          | None        | Horizontal bearing angle in degrees (0-360) - targeting geometry                                                                                                                             |
| elevation_angle_deg          | Optional[float]          | YES          | None        | Vertical elevation angle in degrees - targeting geometry                                                                                                                                      |
| temperature_c                | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Air temperature in Celsius - environmental condition affecting ballistics                                                                                                |
| pressure_hpa                 | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Barometric pressure in hectopascals (hPa) - environmental condition affecting ballistics                                                                                |
| humidity_pct                 | Optional[float]          | YES          | None        | Relative humidity as percentage (0-100) - environmental condition affecting ballistics                                                                                                        |
| clean_bore                   | Optional[str]            | YES          | None        | Bore cleanliness indicator - text field allowing "yes"/"no" or descriptive values                                                                                                            |
| cold_bore                    | Optional[str]            | YES          | None        | Cold bore indicator - text field allowing "yes"/"no" or descriptive values                                                                                                                   |
| distance_m                   | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Target distance in meters - replaces text "distance" field for proper ballistic calculations                                                                             |
| elevation_adjustment_mrad    | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Elevation scope adjustment in milliradians - replaces text field for precise ballistic tracking                                                                          |
| windage_adjustment_mrad      | Optional[float]          | YES          | None        | **METRIC PRIMARY**: Windage scope adjustment in milliradians - replaces text field for precise ballistic tracking                                                                           |
| shot_notes                   | Optional[str]            | YES          | None        | Free-form notes about the specific shot - observations, conditions, anomalies                                                                                                                |
| created_at                   | Optional[datetime]       | YES          | None        | Record creation timestamp (auto-managed by database)                                                                                                                                         |
| updated_at                   | Optional[datetime]       | YES          | None        | Record last update timestamp (auto-managed by database)                                                                                                                                      |

## Imperial Fields (For Migration Compatibility Only)

The following fields exist in the current implementation for backward compatibility during the metric transition. These fields should be **deprecated and removed** in the final metric-only design:

| **Field Name**               | **Data Type**            | **Status**   | **Description**                                                                                                                                                                               |
|------------------------------|--------------------------|--------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| speed_fps                    | Optional[float]          | DEPRECATED   | Velocity in feet per second - to be removed after metric migration                                                                                                                           |
| ke_ft_lb                     | Optional[float]          | DEPRECATED   | Kinetic energy in foot-pounds - to be removed after metric migration                                                                                                                         |
| power_factor                 | Optional[float]          | DEPRECATED   | Imperial power factor - to be removed after metric migration                                                                                                                                 |
| temperature_f                | Optional[float]          | DEPRECATED   | Temperature in Fahrenheit - to be removed after metric migration                                                                                                                             |
| pressure_inhg                | Optional[float]          | DEPRECATED   | Pressure in inches of mercury - to be removed after metric migration                                                                                                                         |
| distance                     | Optional[str]            | DEPRECATED   | Text-based distance field - to be replaced by distance_m                                                                                                                                     |
| elevation_adjustment         | Optional[str]            | DEPRECATED   | Text-based elevation adjustment - to be replaced by elevation_adjustment_mrad                                                                                                                |
| windage_adjustment           | Optional[str]            | DEPRECATED   | Text-based windage adjustment - to be replaced by windage_adjustment_mrad                                                                                                                    |

## Key Relationships

- **dope_sessions**: Many-to-one relationship through `dope_session_id` foreign key
- **User Isolation**: All queries must include `.eq("user_id", user_id)` filter for security

## Metric-Only Design Principles

### 1. Internal Processing
All ballistic calculations, data storage, and business logic operations use metric units exclusively:
- Velocities in m/s (meters per second)
- Energies in J (Joules)  
- Distances in m (meters)
- Temperatures in °C (Celsius)
- Pressures in hPa (hectopascals)
- Scope adjustments in mrad (milliradians)

### 2. Edge Conversion Only
Unit conversions occur only at system boundaries:
- **Data Import**: Convert imperial measurements from chronograph files to metric for storage
- **User Interface**: Display values in user's preferred units (metric or imperial)
- **Data Export**: Convert to target format's required units

### 3. Precision and Accuracy
Metric units provide better precision for ballistic calculations:
- Avoid compound rounding errors from multiple conversions
- Maintain scientific accuracy in ballistic computations
- Support international standards for precision shooting

## Entity Methods

### Core Methods
- `from_supabase_record(record: dict)` - Create entity from database record
- `from_supabase_records(records: List[dict])` - Batch creation from multiple records
- `to_dict()` - Convert entity to dictionary for database operations

### Display Methods (Handle Unit Conversion at UI Boundary)
- `get_speed_display(use_metric: bool = True)` - Format velocity for display
- `get_energy_display(use_metric: bool = True)` - Format kinetic energy for display  
- `get_power_factor_display(use_metric: bool = True)` - Format power factor for display
- `environmental_display` - Format environmental conditions
- `adjustments_display` - Format scope adjustments
- `bore_conditions_display` - Format bore condition indicators

### Validation Methods
- `has_ballistic_data()` - Check if measurement contains velocity/energy data
- `has_environmental_data()` - Check if measurement contains environmental conditions
- `has_targeting_data()` - Check if measurement contains targeting geometry

## Business Logic Requirements

### Data Validation
1. **User Isolation**: All database operations must filter by user_id
2. **Session Linkage**: dope_session_id must reference valid, user-owned DOPE session
3. **Shot Sequencing**: shot_number should be unique within session when provided
4. **Environmental Ranges**: Validate realistic ranges for temperature, pressure, humidity
5. **Ballistic Ranges**: Validate realistic ranges for velocities and energies

### Calculation Dependencies
1. **Kinetic Energy**: Requires both velocity (speed_mps) and bullet mass from parent session
2. **Power Factor**: Calculated from velocity and bullet mass
3. **Ballistic Coefficients**: Used with velocity for trajectory calculations
4. **Environmental Corrections**: Temperature, pressure, humidity affect ballistic performance

### Data Integrity
1. **Orphan Prevention**: Foreign key constraint ensures valid dope_session_id
2. **Timestamp Consistency**: datetime_shot should fall within parent session time window
3. **Unit Consistency**: All metric fields must use consistent unit systems
4. **Precision Maintenance**: Avoid precision loss from unnecessary unit conversions

## Usage Patterns

### Creating New Measurements
```python
measurement = DopeMeasurementModel(
    dope_session_id=session_id,
    user_id=user_id,
    shot_number=1,
    speed_mps=850.5,  # Metric primary
    temperature_c=21.0,  # Metric primary
    pressure_hpa=1013.25  # Metric primary
)
```

### Importing from Imperial Sources
```python
# Convert at import boundary
speed_mps = speed_fps * 0.3048  # Convert fps to m/s
temp_c = (temp_f - 32) * 5/9    # Convert F to C
pressure_hpa = pressure_inhg * 33.8639  # Convert inHg to hPa

measurement = DopeMeasurementModel(
    speed_mps=speed_mps,
    temperature_c=temp_c,
    pressure_hpa=pressure_hpa
)
```

### Display with User Preferences
```python
# UI layer handles unit preference
speed_display = measurement.get_speed_display(use_metric=user_prefers_metric)
energy_display = measurement.get_energy_display(use_metric=user_prefers_metric)
```

This entity design ensures that all internal processing maintains metric consistency while providing flexibility for user interface preferences and data import/export requirements.